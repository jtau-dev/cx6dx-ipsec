#!/usr/bin/bash
#
FIFO_DIR=/local/sandbox/ipsec/fifos/
RUNTIME=79200
#
NoT=${1:-1}
cores=($(seq 0 15) $(seq 32 47))
RHIP=10.15.4.93
RIFN=enp59s0f0
T="\
	devid=\`mst status -v | grep $RIFN | awk '{print \$4}'\`;\
        VFN=($RIFN \`ls /sys/class/infiniband/\$devid/device/virtfn*/net/ | grep enp\`);\
	for ND in \${VFN[@]}; do \
	  IP=\`ip addr show \$ND | grep -E 'inet.*global' | awk '{print \$2}'\`;\
          IP=\${IP//\/24/};\
	  echo \$IP; \
        done\
"
IPs=(`ssh -x $RHIP "$T"`)
#echo ${IPs[@]}

for i in $(seq 0 $(( NoT - 1 )) )
do
    corei=$(( i + NoT ))
    cmd="taskset -c ${cores[$corei]} iperf3 -c ${IPs[$i]} -M 1350 -P1 --logfile ${FIFO_DIR}fifo${i}  -t $RUNTIME &"
    echo $cmd
    eval "$cmd"

done    
wait 
